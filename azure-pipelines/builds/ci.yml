trigger:
  batch: true
  branches:
    include:
    - main
    - release/*

pr:
  branches:
    include:
    - main
    - release/*

variables:
  - name: Codeql.Enabled
    value: true

stages:
- stage: build
  displayName: Build
  jobs:
  - template: /eng/common/templates/jobs/jobs.yml
    parameters:
      enablePublishUsingPipelines: true
      enablePublishBuildArtifacts: true
      enablePublishBuildAssets: true
      publishAssetsImmediately: true
      artifacts:
        publish:
          artifacts: true
          manifests: true
      enableSourceBuild: true
      enablePublishTestResults: true
      jobs:
      - job: Windows_NT_Tests
        timeoutInMinutes: 90
        pool:
          vmImage: windows-latest
        steps:
        - script: $(Build.SourcesDirectory)/build.cmd
                    -test --ci --publish
          displayName: Windows NT Tests
        - task: PublishTestResults@2
          displayName: Publish Test Results
          inputs:
            testRunTitle: 'Windows generate test'
            testRunner: XUnit
            testResultsFiles: 'artifacts/TestResults/**/*.trx'
            publishRunAttachments: true
            mergeTestResults: true
          continueOnError: true
          condition: always()
      - job: Linux_Tests
        pool:
          vmImage: ubuntu-latest
        steps:
        - script: $(Build.SourcesDirectory)/build.sh
                    --test --ci --publish
          displayName: Linux Tests
        - task: PublishTestResults@2
          displayName: Publish Test Results
          inputs:
            testRunTitle: 'Linux generate test'
            testRunner: XUnit
            testResultsFiles: '$(Build.SourcesDirectory)/artifacts/TestResults/**/*.trx'
            publishRunAttachments: true
            mergeTestResults: true
          continueOnError: true
          condition: always()

# Based on - https://github.com/dotnet/arcade/blob/9b3f304c7bc9fd4d11be9ca0b466b83e98d2a191/Documentation/CorePackages/Publishing.md#moving-away-from-the-legacy-pushtoblobfeed-task
- ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
  - template: /eng/common/templates/post-build/post-build.yml
    parameters:
      publishingInfraVersion: 3
      publishAssetsImmediately: true
      enableSourceLinkValidation: false
      #Nuget and Signing Validation are not needed as we only produce a transport package.
      enableSigningValidation: false
      enableNugetValidation: false

